2016-02-25 16:04:02 INFO  Worker:45 - jdbc:oracle:thin:@10.254.5.10:1521:BER1
2016-02-25 16:09:03 INFO  Worker:43 - 
2016-02-25 16:09:13 INFO  Worker:43 - 
2016-02-25 16:09:32 INFO  Worker:43 - select * from dual
2016-02-25 16:29:08 FATAL Worker:99 - java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@10.254.5.10:1521:BER1
2016-02-25 16:29:08 FATAL Worker:99 - java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@10.254.5.11:1521:BER1
2016-02-25 16:29:08 FATAL Worker:49 - 
2016-02-25 16:29:08 FATAL Worker:50 - 
2016-02-25 16:35:41 FATAL Worker:99 - java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@10.254.5.10:1521:BER1
2016-02-25 16:35:42 FATAL Worker:99 - java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@10.254.5.11:1521:BER1
2016-02-25 16:35:57 FATAL Worker:99 - java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@10.254.5.10:1521:BER1
2016-02-25 16:45:51 INFO  Worker:63 - test
2016-02-25 16:45:57 INFO  Worker:63 - Tolya
2016-02-25 16:46:19 INFO  Worker:60 - 1
2016-02-25 16:46:19 INFO  Worker:64 - Tolya
2016-02-25 16:46:28 INFO  Worker:60 - 2
2016-02-25 16:46:28 FATAL Worker:68 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 2
2016-02-25 16:46:54 INFO  Worker:61 - 2
2016-02-25 16:46:54 INFO  Worker:65 - Tolya : Tolya
2016-02-25 16:47:01 INFO  Worker:61 - 2
2016-02-25 16:47:01 INFO  Worker:65 - Tolya : Vazhenin
2016-02-25 16:49:07 INFO  Worker:61 - 2
2016-02-25 16:49:07 INFO  Worker:65 - Tolya : Vazhenin
2016-02-25 17:16:42 INFO  Worker:62 - 2
2016-02-25 17:16:42 INFO  Worker:63 - null:1,:2
2016-02-25 17:16:42 INFO  Worker:66 - Tolya : Vazhenin
2016-02-25 17:16:50 INFO  Worker:62 - 2
2016-02-25 17:16:51 INFO  Worker:63 - :1,:2
2016-02-25 17:16:51 INFO  Worker:66 - Tolya : Vazhenin
2016-02-25 17:17:15 FATAL Worker:70 - java.sql.SQLSyntaxErrorException: ORA-00923: ключевое слово FROM не найдено там, где оно ожидалось

2016-02-25 17:17:26 INFO  Worker:62 - 4
2016-02-25 17:17:26 INFO  Worker:63 - :1,:2,:3,:4
2016-02-25 17:17:26 FATAL Worker:70 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 3
2016-02-25 17:18:43 INFO  Worker:62 - 4
2016-02-25 17:18:43 INFO  Worker:63 - :1,:2,:3,:4
2016-02-25 17:18:43 FATAL Worker:70 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 3
2016-02-25 17:18:51 INFO  Worker:62 - 2
2016-02-25 17:18:51 INFO  Worker:63 - :1,:2
2016-02-25 17:18:51 INFO  Worker:66 - Tolya : Vazhenin
2016-02-25 18:25:41 FATAL Worker:84 - java.sql.SQLSyntaxErrorException: ORA-00923: ключевое слово FROM не найдено там, где оно ожидалось

2016-02-25 18:26:22 FATAL Worker:84 - java.sql.SQLSyntaxErrorException: ORA-00923: ключевое слово FROM не найдено там, где оно ожидалось

2016-02-25 18:27:34 INFO  Worker:59 - select /*+parallel(32)*/          t1.Dt       , t1.Subs_Id n       , sh.trpl_id tarif_n       , t2.t2_region_name lac       , t1.EVENT_DATE strt       , 26 code       , cl.account       , p.msisdn mob_num       , s.ACTIVATION_DATE begin_work       , bwc.min_event_date begin_work_com       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang       , sh.st_id prepaid_platform       , con.dlr_id r_app       , u.usi imsi       , t2.summ amount       , ch.clnt_id       , t3.balance_$       , sh.zone_id       , nvl(t2.lac_a,'N\A') full_lac       , t2.call_date zr_dtfrom (select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (select                to_date('01.01.2016','dd.mm.yyyy') dt,               subs_id,               max(event_date) event_date,               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date          from (        select ct.subs_id,               ct.call_date event_date,               ct.call_date paid_session_date,               to_date('01.01.1988','dd.mm.yyyy') payment_date,               to_date('01.01.1988','dd.mm.yyyy') charge_date          from contour.contour_traffic ct         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1           and ct.sum_price_$  > 0     union all     /* платежи */select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date from (        select sh.subs_id,               pd.cre_date event_date,               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,               pd.cre_date payment_date,               to_date('01.01.1988','dd.mm.yyyy') charge_date        from payment p         join pay_doc pd on pd.pdoc_id=p.pdoc_id          and pd.summ_$>=150          and pd.del_user_id is null         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90        join subs_history sh on sh.clnt_id=p.clnt_id          and pd.cre_date >= sh.stime          and pd.cre_date < sh.etime          and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1                  and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */         and sh.stat_id not in (0,3)        join pay_list pl on pl.plst_id=pd.plst_id         and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */        union         select sh.subs_id,               pd.cre_date event_date,               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,               pd.cre_date payment_date,               to_date('01.01.1988','dd.mm.yyyy') charge_date        from payment p         join pay_doc pd on pd.pdoc_id=p.pdoc_id          and pd.summ_$>=150          and pd.del_user_id is null         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1                 join subs_history sh on sh.clnt_id=p.clnt_id          and pd.cre_date >= sh.stime          and pd.cre_date < sh.etime           and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */         )pay group by pay.subs_id     union all     /* начисления */        select ch.subs_id,               ch.charge_date event_date,               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,               to_date('01.01.1988','dd.mm.yyyy') payment_date,               ch.charge_date charge_date          from charge ch     left join service serv on ch.serv_id=serv.serv_id         where ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90            and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1           and ch.del_date is null           and ch.chtype_id = 2 /* Only subs charges  */                                 and ch.summ_$ > 0)      group by subs_id)      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))) t1left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ          from (select Subs_Id,                       sum(Sum_Price_$) summ,                       max(Ctraffic_Id) Ctraffic_Id,                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id                  from Contour_Traffic                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90                    and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1                 group by Subs_Id) t          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id         union all        select null, ch.subs_id,null,null, sum(ch.summ_$) summ           from charge ch          where ch.del_date is null           and ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90            and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1              group by  ch.subs_id) group by Subs_Id) t2       on t1.subs_id=t2.subs_id    join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id join client_history                  ch  on sh.clnt_id = ch.clnt_id      join contract                        con on ch.clnt_id = con.clnt_id    left join subs_usi_history           suh on sh.subs_id=suh.subs_id  and t1.dt+1-1/86400 >= suh.Stime  and t1.dt+1-1/86400 <  suh.Etime     left join usi                        u   on suh.usi_id=u.usi_id join subscriber                      s   on t1.subs_id=s.subs_id join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$         from Client_Balance Cb         join Smaster.Balance_Dict Bd           on Cb.Balance_Id = Bd.Balance_Id          and Bd.Bal_Type_Id not in (2, 5)     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id   and sod.subs_fld_id=32  and t1.dt+1-1/86400 >= sod.stime   and t1.dt+1-1/86400 <= sod.etime join client                          cl  on sh.clnt_id=cl.clnt_id left join phone                      p   on sh.phone_id=p.phone_id where t1.dt+1-1/86400 >= Sh.Stime   and t1.dt+1-1/86400 <  Sh.Etime   and t1.dt+1-1/86400 >= ch.Stime   and t1.dt+1-1/86400 <  ch.Etime    and t1.dt+1-1/86400 >= con.Stime   and t1.dt+1-1/86400 <  con.Etime
2016-02-25 18:27:34 FATAL Worker:85 - java.sql.SQLSyntaxErrorException: ORA-00923: ключевое слово FROM не найдено там, где оно ожидалось

2016-02-25 18:28:35 INFO  Worker:59 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('01.01.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime 
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge ch
     left join service serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
 join subscriber                      s   on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-25 18:28:45 FATAL Worker:85 - java.sql.SQLException: Недопустимый индекс столбца
2016-02-25 18:29:37 INFO  Worker:59 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('01.01.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime 
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge ch
     left join service serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
 join subscriber                      s   on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-25 18:30:43 INFO  Worker:59 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('01.01.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime 
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment p 
        join pay_doc pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
        join subs_history sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge ch
     left join service serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
 join subscriber                      s   on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-25 18:37:20 FATAL Worker:85 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:39:04 FATAL Worker:84 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:40:01 INFO  Worker:70 - Start executing Query
2016-02-25 18:40:03 INFO  Worker:73 - Start inserting records
2016-02-25 18:40:03 FATAL Worker:87 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:41:08 INFO  Worker:70 - Start executing Query
2016-02-25 18:41:12 INFO  Worker:73 - Start inserting records
2016-02-25 18:41:12 INFO  Worker:74 - insert into Contour.T2_Active_Subscribers values(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16,:17,:18,:19,:20)
2016-02-25 18:41:12 FATAL Worker:88 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:44:52 INFO  Worker:70 - Start executing Query
2016-02-25 18:44:57 INFO  Worker:73 - Start inserting records
2016-02-25 18:44:57 INFO  Worker:74 - insert into Contour.T2_Active_Subscribers(DT,
N,
TARIF_N,
LAC,
STRT,
CODE,
ACCOUNT,
MOB_NUM,
BEGIN_WORK,
BEGIN_WORK_COM,
LANG,
PREPAID_PLATFORM,
R_APP,
IMSI,
AMOUNT,
CLNT_ID,
BALANCE_$,
ZONE_ID,
FULL_LAC,
ZR_DT) values(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16,:17,:18,:19,:20)
2016-02-25 18:44:57 FATAL Worker:107 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:46:04 INFO  Worker:90 - Start executing Query
2016-02-25 18:46:06 INFO  Worker:93 - Start inserting records
2016-02-25 18:46:06 INFO  Worker:94 - insert into Contour.T2_Active_Subscribers(DT,
N,
TARIF_N,
LAC,
STRT,
CODE,
ACCOUNT,
MOB_NUM,
BEGIN_WORK,
BEGIN_WORK_COM,
LANG,
PREPAID_PLATFORM,
R_APP,
IMSI,
AMOUNT,
CLNT_ID,
BALANCE_$,
ZONE_ID,
FULL_LAC,
ZR_DT,) values(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16,:17,:18,:19,:20)
2016-02-25 18:46:06 FATAL Worker:108 - java.sql.SQLSyntaxErrorException: ORA-01747: неверные спецификации для user.table.column, table.column или column

2016-02-25 18:46:18 INFO  Worker:90 - Start executing Query
2016-02-25 18:46:22 INFO  Worker:93 - Start inserting records
2016-02-25 18:46:22 INFO  Worker:94 - insert into Contour.T2_Active_Subscribers(DT,
N,
TARIF_N,
LAC,
STRT,
CODE,
ACCOUNT,
MOB_NUM,
BEGIN_WORK,
BEGIN_WORK_COM,
LANG,
PREPAID_PLATFORM,
R_APP,
IMSI,
AMOUNT,
CLNT_ID,
BALANCE_$,
ZONE_ID,
FULL_LAC,
ZR_DT) values(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16,:17,:18,:19,:20)
2016-02-25 18:46:22 FATAL Worker:108 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:50:19 INFO  Worker:90 - Start executing Query
2016-02-25 18:50:23 INFO  Worker:93 - Start inserting records
2016-02-25 18:50:23 INFO  Worker:94 - insert into Contour.T2_Active_Subscribers(DT,
N,
TARIF_N,
LAC,
STRT,
CODE,
ACCOUNT,
MOB_NUM,
BEGIN_WORK,
BEGIN_WORK_COM,
LANG,
PREPAID_PLATFORM,
R_APP,
IMSI,
AMOUNT,
CLNT_ID,
BALANCE_$,
ZONE_ID,
FULL_LAC,
ZR_DT) values(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16,:17,:18,:19,:20)
2016-02-25 18:50:23 INFO  Worker:98 - 93
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 12
2016-02-25 18:50:23 INFO  Worker:98 - 93
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 12
2016-02-25 18:50:23 INFO  Worker:98 - 93
2016-02-25 18:50:23 INFO  Worker:98 - 93
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 12
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 2
2016-02-25 18:50:23 INFO  Worker:98 - 12
2016-02-25 18:50:23 INFO  Worker:98 - 93
2016-02-25 18:50:23 FATAL Worker:109 - java.sql.SQLDataException: ORA-01861: литерал не соответствует формату строки

2016-02-25 18:55:38 INFO  Worker:90 - Start executing Query
2016-02-25 18:55:41 INFO  Worker:93 - Start inserting records
2016-02-25 18:55:41 INFO  Worker:98 - 93
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 12
2016-02-25 18:55:41 INFO  Worker:98 - 93
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 12
2016-02-25 18:55:41 INFO  Worker:98 - 93
2016-02-25 18:55:41 INFO  Worker:98 - 93
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 12
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 2
2016-02-25 18:55:41 INFO  Worker:98 - 12
2016-02-25 18:55:41 INFO  Worker:98 - 93
2016-02-25 18:55:41 INFO  Worker:115 - Commiting
2016-02-25 19:08:41 INFO  Worker:90 - Start executing Query
2016-02-25 19:08:45 INFO  Worker:90 - Start executing Query
2016-02-25 19:08:51 INFO  Worker:90 - Start executing Query
2016-02-25 19:10:06 INFO  Worker:90 - Start executing Query
2016-02-25 19:11:33 INFO  Worker:93 - Start executing Query
2016-02-25 19:12:20 INFO  Worker:93 - Start executing Query
2016-02-25 19:20:24 INFO  Worker:96 - Start inserting records
2016-02-25 19:20:24 FATAL Worker:122 - java.sql.SQLIntegrityConstraintViolationException: ORA-01400: невозможно вставить NULL в ("CONTOUR"."T2_ACTIVE_SUBSCRIBERS"."IMSI")

2016-02-25 20:23:33 INFO  Worker:93 - Start executing Query
2016-02-25 20:28:27 INFO  Worker:96 - Start inserting records
2016-02-25 20:45:15 INFO  Worker:117 - Commiting
2016-02-25 21:16:47 INFO  Worker:93 - Start executing Query
2016-02-25 21:21:15 INFO  Worker:96 - Start inserting records
2016-02-25 21:37:56 INFO  Worker:117 - Commiting
2016-02-25 21:44:02 INFO  Worker:93 - Start executing Query
2016-02-25 21:48:23 INFO  Worker:96 - Start inserting records
2016-02-25 22:05:10 INFO  Worker:117 - Commiting
2016-02-25 23:48:04 INFO  Worker:93 - Start executing Query
2016-02-25 23:48:07 INFO  Worker:96 - Start inserting records
2016-02-25 23:48:07 INFO  Worker:117 - Commiting
2016-02-26 09:09:47 INFO  Worker:93 - Start executing Query
2016-02-26 09:16:20 INFO  Worker:96 - Start inserting records
2016-02-26 09:16:20 FATAL Worker:124 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 2
2016-02-26 09:25:43 INFO  Worker:93 - Start executing Query
2016-02-26 09:25:50 INFO  Worker:96 - Start inserting records
2016-02-26 09:27:35 INFO  Worker:93 - Start executing Query
2016-02-26 09:27:37 INFO  Worker:96 - Start inserting records
2016-02-26 09:29:12 INFO  Worker:93 - Start executing Query
2016-02-26 09:29:14 INFO  Worker:96 - Start inserting records
2016-02-26 09:29:33 INFO  Worker:93 - Start executing Query
2016-02-26 09:29:36 INFO  Worker:96 - Start inserting records
2016-02-26 09:29:36 FATAL Worker:124 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 2
2016-02-26 09:31:49 INFO  Worker:93 - Start executing Query
2016-02-26 09:31:51 INFO  Worker:96 - Start inserting records
2016-02-26 09:32:53 INFO  Worker:93 - Start executing Query
2016-02-26 09:32:55 INFO  Worker:96 - Start inserting records
2016-02-26 09:37:39 INFO  Worker:93 - Start executing Query
2016-02-26 09:37:41 INFO  Worker:96 - Start inserting records
2016-02-26 09:37:41 INFO  Worker:102 - 2016-02-19 00:00:00.0
2016-02-26 09:37:41 FATAL Worker:124 - java.sql.SQLException: В индексе отсутствует параметр IN или OUT:: 2
2016-02-26 09:39:46 INFO  Worker:93 - Start executing Query
2016-02-26 09:39:48 INFO  Worker:96 - Start inserting records
2016-02-26 09:39:48 INFO  Worker:102 - 2016-02-19 00:00:00.0
2016-02-26 09:39:48 FATAL Worker:124 - java.sql.SQLException: Недопустимый тип столбца: getTimestamp not implemented for class oracle.jdbc.driver.T4CNumberAccessor
2016-02-26 09:40:04 INFO  Worker:93 - Start executing Query
2016-02-26 09:40:06 INFO  Worker:96 - Start inserting records
2016-02-26 09:40:06 INFO  Worker:118 - Commiting
2016-02-26 10:02:05 INFO  Worker:93 - Start executing Query
2016-02-26 10:06:53 INFO  Worker:96 - Start inserting records
2016-02-26 10:27:01 INFO  Worker:93 - Start executing Query
2016-02-26 10:31:52 INFO  Worker:96 - Start inserting records
2016-02-26 10:50:47 INFO  Worker:116 - Commiting
2016-02-26 10:50:47 FATAL Worker:137 - java.sql.SQLRecoverableException: Закрытая команда
2016-02-26 12:05:56 INFO  T2_Active_Subscribers:213 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , get_begin_work_com(t1.subs_id,1) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('19.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('19.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('19.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 --left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   

2016-02-26 12:05:56 FATAL T2_Active_Subscribers:287 - java.lang.NullPointerException
2016-02-26 12:06:51 INFO  T2_Active_Subscribers:213 - d:\Dropbox\Programming\NetBeansProjects\NetBeansProjects\ContourReports\test.sql
2016-02-26 12:06:51 FATAL T2_Active_Subscribers:287 - java.lang.NullPointerException
2016-02-26 12:07:29 INFO  T2_Active_Subscribers:213 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , get_begin_work_com(t1.subs_id,1) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               Wed Feb 24 12:07:29 ALMT 2016 dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90
           and ct.call_date    <  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90
         and pd.cre_date <  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90
         and pd.cre_date 	<  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90 
           and ch.charge_date <  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90 
                   and Call_Date <  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(Wed Feb 24 12:07:29 ALMT 2016)-90 
           and ch.charge_date <  trunc(Wed Feb 24 12:07:29 ALMT 2016)+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 --left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-26 12:07:29 FATAL T2_Active_Subscribers:287 - java.lang.NullPointerException
2016-02-26 12:08:27 INFO  T2_Active_Subscribers:214 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , get_begin_work_com(t1.subs_id,1) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               24.02.2016 dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(24.02.2016)-90
           and ct.call_date    <  trunc(24.02.2016)+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(24.02.2016)-90
         and pd.cre_date <  trunc(24.02.2016)+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(24.02.2016)-90
         and pd.cre_date 	<  trunc(24.02.2016)+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(24.02.2016)-90 
           and ch.charge_date <  trunc(24.02.2016)+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(24.02.2016)-90 
                   and Call_Date <  trunc(24.02.2016)+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(24.02.2016)-90 
           and ch.charge_date <  trunc(24.02.2016)+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 --left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-26 12:08:27 FATAL T2_Active_Subscribers:288 - java.lang.NullPointerException
2016-02-26 12:08:52 INFO  T2_Active_Subscribers:214 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , get_begin_work_com(t1.subs_id,1) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('24.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('24.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('24.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 --left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-26 12:08:52 FATAL T2_Active_Subscribers:288 - java.lang.NullPointerException
2016-02-26 12:13:57 INFO  T2_Active_Subscribers:214 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , get_begin_work_com(t1.subs_id,1) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('20.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('20.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('20.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 --left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime

2016-02-26 12:14:04 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:25:05 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:44:03 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:44:03 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытая команда
2016-02-26 12:46:15 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:46:17 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:46:17 FATAL T2_Active_Subscribers:272 - java.sql.SQLIntegrityConstraintViolationException: ORA-00001: нарушено ограничение уникальности (CONTOUR.T2_SUBSID#CALLDATE#PK)

2016-02-26 12:46:17 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытая команда
2016-02-26 12:46:35 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:46:40 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:46:40 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:46:40 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытая команда
2016-02-26 12:47:11 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:47:14 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:47:20 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:47:30 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытая команда
2016-02-26 12:47:44 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:47:46 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:47:46 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:47:46 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытое соединение
2016-02-26 12:48:04 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:48:04 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:48:04 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:48:04 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытое соединение
2016-02-26 12:48:12 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:48:16 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:48:20 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:48:28 FATAL T2_Active_Subscribers:288 - java.sql.SQLRecoverableException: Закрытое соединение
2016-02-26 12:49:32 INFO  T2_Active_Subscribers:245 - Start executing Query
2016-02-26 12:49:34 INFO  T2_Active_Subscribers:248 - Start inserting records
2016-02-26 12:49:34 INFO  T2_Active_Subscribers:267 - Commiting
2016-02-26 12:53:27 FATAL T2_Active_Subscribers:275 - java.sql.SQLSyntaxErrorException: ORA-00904: "OB"."OB_EDATE": недопустимый идентификатор

2016-02-26 12:53:27 FATAL T2_Active_Subscribers:297 - java.lang.NullPointerException
2016-02-26 12:53:41 INFO  T2_Active_Subscribers:248 - Start executing Query
2016-02-26 12:53:46 INFO  T2_Active_Subscribers:251 - Start inserting records
2016-02-26 12:53:46 INFO  T2_Active_Subscribers:270 - Commiting
2016-02-26 13:04:16 INFO  T2_Active_Subscribers:250 - Start executing Query
2016-02-26 13:13:51 INFO  T2_Active_Subscribers:253 - Start inserting records
2016-02-26 13:30:00 INFO  T2_Active_Subscribers:272 - Commiting
2016-02-26 14:43:28 INFO  T2_Active_Subscribers:221 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('25.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.charge_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */                      
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 14:43:28 FATAL T2_Active_Subscribers:302 - java.lang.NullPointerException
2016-02-26 16:07:45 INFO  Tele2Reports:251 - Start executing Query
2016-02-26 16:08:10 INFO  Tele2Reports:251 - Start executing Query
2016-02-26 16:10:04 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('25.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.charge_date >= trunc(to_date('25.02.2016','dd.mm.yyyy'))-90 
           and ch.charge_date <  trunc(to_date('25.02.2016','dd.mm.yyyy'))+1        
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:10:04 FATAL Tele2Reports:300 - java.lang.NullPointerException
2016-02-26 16:23:56 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:23:56 FATAL Tele2Reports:300 - java.lang.NullPointerException
2016-02-26 16:23:56 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('16.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:23:56 FATAL Tele2Reports:300 - java.lang.NullPointerException
2016-02-26 16:23:56 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('17.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:23:56 FATAL Tele2Reports:300 - java.lang.NullPointerException
2016-02-26 16:25:07 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:25:07 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('16.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('16.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('16.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 16:25:07 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('17.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 17:44:52 INFO  Tele2Reports:329 - Start executing Query
2016-02-26 18:05:57 INFO  Tele2Reports:332 - Start inserting records
2016-02-26 18:05:57 FATAL Tele2Reports:343 - java.sql.SQLException: Недопустимый тип столбца: getInt not implemented for class oracle.jdbc.driver.T4CDateAccessor
2016-02-26 20:02:15 INFO  Tele2Reports:219 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , bwc.min_event_date begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 left join t2_subs_begin_work_com     bwc on t1.SUBS_ID = bwc.c_subs_id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
 where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 20:05:32 INFO  Tele2Reports:238 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select min(Event_Date)Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-26 20:10:51 INFO  Tele2Reports:270 - Start executing Query
2016-02-26 20:19:45 INFO  Tele2Reports:273 - Start inserting records
2016-02-26 20:37:12 INFO  Tele2Reports:292 - Commiting
2016-02-29 09:01:19 INFO  Tele2Reports:238 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select min(Event_Date)Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-29 09:08:21 INFO  Tele2Reports:270 - Start executing Query
2016-02-29 09:24:28 INFO  Tele2Reports:273 - Start inserting records
2016-02-29 09:40:39 INFO  Tele2Reports:292 - Commiting
2016-02-29 09:40:39 INFO  Tele2Reports:238 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('17.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('17.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('17.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select min(Event_Date)Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-29 09:40:39 INFO  Tele2Reports:238 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('18.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select min(Event_Date)Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-29 09:42:56 INFO  Tele2Reports:238 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('18.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy') Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)

2016-02-29 09:44:02 INFO  Tele2Reports:270 - Start executing Query
2016-02-29 09:54:43 INFO  Tele2Reports:240 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('18.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('18.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('18.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy')) Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)
   and ch.ct_id not in (4,5,0)
2016-02-29 10:03:41 INFO  Tele2Reports:252 - Delete data in Contour.T2_Active_Subscribers where DT=15.02.2016
2016-02-29 10:03:54 INFO  Tele2Reports:280 - Start executing Query
2016-02-29 10:19:41 INFO  Tele2Reports:283 - Start inserting records
2016-02-29 10:19:42 FATAL Tele2Reports:307 - java.sql.SQLIntegrityConstraintViolationException: ORA-00001: нарушено ограничение уникальности (CONTOUR.T2_SUBSID#CALLDATE#PK)

2016-02-29 10:22:01 INFO  Tele2Reports:242 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy')) Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)
   and ch.ct_id not in (4,5,0)   and t1.subs_id=5915762

2016-02-29 11:36:53 INFO  Tele2Reports:253 - Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:37:11 INFO  Tele2Reports:281 - Start executing Query
2016-02-29 11:37:16 INFO  Tele2Reports:284 - Start inserting records
2016-02-29 11:37:16 FATAL Tele2Reports:308 - java.sql.SQLIntegrityConstraintViolationException: ORA-00001: нарушено ограничение уникальности (CONTOUR.T2_SUBSID#CALLDATE#PK)

2016-02-29 11:44:15 INFO  Tele2Reports:252 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:44:15 INFO  Tele2Reports:254 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:44:15 INFO  Tele2Reports:283 - Start executing Query
2016-02-29 11:44:18 INFO  Tele2Reports:252 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:44:19 INFO  Tele2Reports:286 - Start inserting records
2016-02-29 11:44:19 INFO  Tele2Reports:305 - Commiting
2016-02-29 11:44:19 INFO  Tele2Reports:254 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:44:19 INFO  Tele2Reports:283 - Start executing Query
2016-02-29 11:44:19 INFO  Tele2Reports:286 - Start inserting records
2016-02-29 11:44:19 INFO  Tele2Reports:305 - Commiting
2016-02-29 11:47:47 INFO  Tele2Reports:252 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:47:47 INFO  Tele2Reports:256 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 193
2016-02-29 11:47:47 INFO  Tele2Reports:285 - Start executing Query
2016-02-29 11:47:47 INFO  Tele2Reports:288 - Start inserting records
2016-02-29 11:47:47 INFO  Tele2Reports:307 - Commiting
2016-02-29 11:47:58 INFO  Tele2Reports:252 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:47:58 INFO  Tele2Reports:256 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0
2016-02-29 11:47:58 INFO  Tele2Reports:285 - Start executing Query
2016-02-29 11:48:00 INFO  Tele2Reports:288 - Start inserting records
2016-02-29 11:48:00 INFO  Tele2Reports:307 - Commiting
2016-02-29 11:49:47 INFO  Tele2Reports:253 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:49:47 INFO  Tele2Reports:257 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0
2016-02-29 11:49:47 INFO  Tele2Reports:286 - Start executing Query
2016-02-29 11:49:50 INFO  Tele2Reports:290 - Stop executing Query, Time spent 2
2016-02-29 11:49:50 INFO  Tele2Reports:293 - Start inserting records
2016-02-29 11:49:50 INFO  Tele2Reports:312 - Commiting
2016-02-29 11:50:34 INFO  Tele2Reports:253 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:50:34 INFO  Tele2Reports:257 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0 seconds
2016-02-29 11:50:35 INFO  Tele2Reports:286 - Start executing Query
2016-02-29 11:50:35 INFO  Tele2Reports:290 - Stop executing Query, Time spent 0 Minutes
2016-02-29 11:50:35 INFO  Tele2Reports:293 - Start inserting records
2016-02-29 11:50:35 INFO  Tele2Reports:312 - Commiting
2016-02-29 11:50:52 INFO  Tele2Reports:253 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:50:52 INFO  Tele2Reports:257 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0 seconds
2016-02-29 11:50:52 INFO  Tele2Reports:286 - Start executing Query
2016-02-29 11:50:55 INFO  Tele2Reports:290 - Stop executing Query, Time spent 0.03833333333333333 Minutes
2016-02-29 11:50:55 INFO  Tele2Reports:293 - Start inserting records
2016-02-29 11:50:55 INFO  Tele2Reports:312 - Commiting
2016-02-29 11:51:30 INFO  Tele2Reports:253 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:51:30 INFO  Tele2Reports:257 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0 seconds
2016-02-29 11:51:30 INFO  Tele2Reports:286 - Start executing Query
2016-02-29 11:51:32 FATAL Tele2Reports:317 - java.lang.RuntimeException: Uncompilable source code - Erroneous tree type: <any>
2016-02-29 11:51:41 INFO  Tele2Reports:253 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 11:51:42 INFO  Tele2Reports:257 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0 seconds
2016-02-29 11:51:42 INFO  Tele2Reports:286 - Start executing Query
2016-02-29 11:51:44 INFO  Tele2Reports:290 - Stop executing Query, Time spent 0 Minutes
2016-02-29 11:51:44 INFO  Tele2Reports:293 - Start inserting records
2016-02-29 11:51:44 INFO  Tele2Reports:312 - Commiting
2016-02-29 12:00:46 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:00:46 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 159,00 minutes
2016-02-29 12:00:46 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:00:47 INFO  Tele2Reports:292 - Stop executing Query, Time spent 1466,00 Minutes
2016-02-29 12:00:47 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:00:47 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:01:12 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:01:12 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:01:12 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:01:14 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:01:14 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:01:14 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:01:48 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:01:49 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,0000 minutes
2016-02-29 12:01:49 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:01:51 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,0000 Minutes
2016-02-29 12:01:51 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:01:51 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:02:04 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:02:05 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,0000 minutes
2016-02-29 12:02:05 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:02:07 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,0000 Minutes
2016-02-29 12:02:07 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:02:07 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:02:12 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:02:13 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 00,0000 minutes
2016-02-29 12:02:13 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:02:15 INFO  Tele2Reports:292 - Stop executing Query, Time spent 00,0000 Minutes
2016-02-29 12:02:15 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:02:15 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:02:19 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:02:20 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 00 0000 minutes
2016-02-29 12:02:20 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:02:20 INFO  Tele2Reports:292 - Stop executing Query, Time spent 00 0000 Minutes
2016-02-29 12:02:20 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:02:20 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:05:25 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:05:25 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:05:25 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:05:25 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:05:25 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:05:25 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:05:25 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:05:25 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:05:40 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:05:41 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:05:41 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:05:41 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:05:43 INFO  Tele2Reports:476 - 2.0
2016-02-29 12:05:43 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:05:43 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:05:43 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:06:00 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:06:00 INFO  Tele2Reports:476 - 0
2016-02-29 12:06:00 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:06:00 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:06:01 INFO  Tele2Reports:476 - 0
2016-02-29 12:06:01 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:06:01 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:06:01 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:06:09 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:06:09 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:06:09 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:06:09 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:06:11 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:06:11 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:06:11 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:06:11 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:10:41 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:10:41 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:41 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:10:41 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:10:43 INFO  Tele2Reports:476 - 2.0
2016-02-29 12:10:43 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:10:43 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:10:43 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:10:45 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:10:45 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:45 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:10:45 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:10:45 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:45 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:10:45 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:10:45 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:10:57 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:10:57 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:57 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:10:57 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:10:57 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:57 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:10:57 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:10:57 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:10:59 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:10:59 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:10:59 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:10:59 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:11:02 INFO  Tele2Reports:476 - 0.03333333333333333
2016-02-29 12:11:02 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:11:02 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:11:02 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:11:36 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:11:36 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:11:36 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:11:36 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:11:39 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:11:39 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:11:39 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:11:39 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:11:49 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:11:49 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:11:49 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:11:49 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:11:52 INFO  Tele2Reports:476 - 0.05
2016-02-29 12:11:52 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,00 Minutes
2016-02-29 12:11:52 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:11:52 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:11:57 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:11:57 INFO  Tele2Reports:476 - 0.0
2016-02-29 12:11:57 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016' Time spent 0,00 minutes
2016-02-29 12:11:57 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:12:01 INFO  Tele2Reports:476 - 0.05
2016-02-29 12:12:01 INFO  Tele2Reports:292 - Stop executing Query, Time spent 0,05 Minutes
2016-02-29 12:12:01 INFO  Tele2Reports:295 - Start inserting records
2016-02-29 12:12:01 INFO  Tele2Reports:314 - Commiting
2016-02-29 12:13:07 INFO  Tele2Reports:255 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 12:13:07 INFO  Tele2Reports:258 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016Time spent 0,00 minutes
2016-02-29 12:13:07 INFO  Tele2Reports:287 - Start executing Query
2016-02-29 12:13:10 INFO  Tele2Reports:291 - Stop executing QueryTime spent 0,05 minutes
2016-02-29 12:13:10 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 12:13:10 INFO  Tele2Reports:313 - Commiting
2016-02-29 12:16:32 INFO  Tele2Reports:257 - Start process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016'
2016-02-29 12:16:32 INFO  Tele2Reports:260 - End process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016 Time spent 0,00 minutes
2016-02-29 12:16:47 INFO  Tele2Reports:289 - Start executing Query
2016-02-29 12:18:05 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016'
2016-02-29 12:18:06 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016 Time spent 0,00 minutes
2016-02-29 12:18:06 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 12:46:11 INFO  Tele2Reports:291 - Stop executing Query Time spent 28,07 minutes
2016-02-29 12:46:11 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 12:59:56 FATAL Tele2Reports:320 - java.sql.SQLRecoverableException: ORA-01089: никакие действия не разрешены, т.к. идет срочный останов

2016-02-29 13:01:15 FATAL Tele2Reports:327 - java.sql.SQLRecoverableException: Данные для считывания из сокета отсутствуют
2016-02-29 13:01:15 FATAL Tele2Reports:344 - java.sql.SQLRecoverableException: Данные для считывания из сокета отсутствуют
2016-02-29 13:01:15 FATAL Tele2Reports:432 - java.sql.SQLRecoverableException: ORA-01034: ORACLE not available
ORA-27101: shared memory realm does not exist
SVR4 Error: 2: No such file or directory

2016-02-29 13:01:15 FATAL Tele2Reports:235 - oracle.jdbc.driver.T4CConnection@4f970963
2016-02-29 13:01:15 FATAL Tele2Reports:236 - 
2016-02-29 15:28:20 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016'
2016-02-29 15:29:31 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='15.02.2016 Time spent 1,17 minutes
2016-02-29 15:30:06 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 15:50:55 INFO  Tele2Reports:291 - Stop executing Query Time spent 20,80 minutes
2016-02-29 15:50:55 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 16:44:26 INFO  Tele2Reports:314 - Stop inserting records Time spent 53,50 minutes
2016-02-29 16:44:26 INFO  Tele2Reports:315 - Commiting
2016-02-29 16:44:29 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016'
2016-02-29 16:45:06 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='16.02.2016 Time spent 0,60 minutes
2016-02-29 16:45:10 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 16:53:36 INFO  Tele2Reports:291 - Stop executing Query Time spent 8,42 minutes
2016-02-29 16:53:36 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 17:13:47 INFO  Tele2Reports:314 - Stop inserting records Time spent 20,18 minutes
2016-02-29 17:13:47 INFO  Tele2Reports:315 - Commiting
2016-02-29 17:13:47 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='17.02.2016'
2016-02-29 17:13:49 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='17.02.2016 Time spent 0,02 minutes
2016-02-29 17:13:52 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 17:23:04 INFO  Tele2Reports:291 - Stop executing Query Time spent 9,18 minutes
2016-02-29 17:23:04 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 17:41:47 INFO  Tele2Reports:314 - Stop inserting records Time spent 18,72 minutes
2016-02-29 17:41:47 INFO  Tele2Reports:315 - Commiting
2016-02-29 17:41:47 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='18.02.2016'
2016-02-29 17:41:49 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='18.02.2016 Time spent 0,02 minutes
2016-02-29 17:41:52 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 17:50:12 INFO  Tele2Reports:291 - Stop executing Query Time spent 8,33 minutes
2016-02-29 17:50:12 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 18:08:05 INFO  Tele2Reports:314 - Stop inserting records Time spent 17,88 minutes
2016-02-29 18:08:05 INFO  Tele2Reports:315 - Commiting
2016-02-29 18:08:06 INFO  Tele2Reports:256 - Start process : Delete Contour.T2_Active_Subscribers where DT='19.02.2016'
2016-02-29 18:08:08 INFO  Tele2Reports:259 - End process : Delete Contour.T2_Active_Subscribers where DT='19.02.2016 Time spent 0,03 minutes
2016-02-29 18:08:11 INFO  Tele2Reports:288 - Start executing Query
2016-02-29 18:16:43 INFO  Tele2Reports:291 - Stop executing Query Time spent 8,52 minutes
2016-02-29 18:16:43 INFO  Tele2Reports:294 - Start inserting records
2016-02-29 18:37:59 INFO  Tele2Reports:314 - Stop inserting records Time spent 21,25 minutes
2016-02-29 18:37:59 INFO  Tele2Reports:315 - Commiting
2016-03-01 11:11:16 INFO  Tele2Reports:245 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select least(nvl(s.activation_date,to_date('31.12.2999','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy')) Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)
 /* закрытых абонентов не учитываем */   and ch.ct_id not in (4,5,0) /* не учитываем служебные номера */   and bwc.Event_Date < t1.dt+1 /* BEGIN_WORK_COM не может быть больше даты выборки */ 
2016-03-02 09:37:57 INFO  Tele2Reports:245 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select greatest(nvl(s.activation_date,to_date('31.12.1899','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy')) Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3)
 /* закрытых абонентов не учитываем */   and ch.ct_id not in (4,5,0) /* не учитываем служебные номера */   and bwc.Event_Date < t1.dt+1 /* BEGIN_WORK_COM не может быть больше даты выборки */ 
2016-03-02 09:39:15 INFO  Tele2Reports:245 - select /*+parallel(32)*/ 
         t1.Dt
       , t1.Subs_Id n
       , sh.trpl_id tarif_n
       , t2.t2_region_name lac
       , t1.EVENT_DATE strt
       , 26 code
       , cl.account
       , p.msisdn mob_num
       , s.ACTIVATION_DATE begin_work
       , greatest(s.activation_date,nvl(bwc.event_date,to_date('01.01.1888','dd.mm.yyyy'))) begin_work_com
       , decode(nvl(sod.field_value,'kz'),'ru',1,'kz',3,2) lang
       , sh.st_id prepaid_platform
       , con.dlr_id r_app
       , u.usi imsi
       , t2.summ amount
       , ch.clnt_id
       , t3.balance_$
       , sh.zone_id
       , nvl(t2.lac_a,'N\A') full_lac
       , t2.call_date zr_dt
from (
select "DT","SUBS_ID","EVENT_DATE","PAID_SESSION_DATE","PAYMENT_DATE","CHARGE_DATE" from (
select 
               to_date('15.02.2016','dd.mm.yyyy') dt,
               subs_id,
               max(event_date) event_date,
               max(nvl(paid_session_date,to_date('01.01.1988','dd.mm.yyyy'))) paid_session_date,
               max(nvl(payment_date,to_date('01.01.1988','dd.mm.yyyy'))) payment_date,
               max(nvl(charge_date,to_date('01.01.1988','dd.mm.yyyy'))) charge_date
          from (
        select ct.subs_id,
               ct.call_date event_date,
               ct.call_date paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
          from contour.contour_traffic ct
         where ct.call_date    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ct.call_date    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ct.sum_price_$  > 0
     union all
     /* платежи */
select pay.subs_id, max(event_date) event_date, max(paid_session_date) paid_session_date, max(payment_date) payment_date, max(charge_date) charge_date
 from (
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$>=150 
         and pd.del_user_id is null
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date >= sh.stime 
         and pd.cre_date < 	sh.etime 
         and pd.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
         and pd.pt_id = 1 /* Если это банковская оплата, то исключаем СПИСАНИЕ ДЗ / КЗ */
         and sh.stat_id not in (0,3)
        join pay_list 		pl on pl.plst_id=pd.plst_id 
        and pl.bank_id not in (34,74) /* исключаем СПИСАНИЕ ДЗ / КЗ */
        union 
        select sh.subs_id,
               pd.cre_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               pd.cre_date payment_date,
               to_date('01.01.1988','dd.mm.yyyy') charge_date
        from payment 		p 
        join pay_doc 		pd on pd.pdoc_id=p.pdoc_id 
         and pd.summ_$ 		>= 150 
         and pd.del_user_id is null
         and pd.cre_date 	>= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
         and pd.cre_date 	<  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1         
        join subs_history 	sh on sh.clnt_id=p.clnt_id 
         and pd.cre_date 	>= sh.stime 
         and pd.cre_date 	< sh.etime  
         and (pd.pt_id > 1 or pd.pt_id=-1) /* учитываем все кроме банковской оплаты + перенос баланса */
         and sh.stat_id not in (0,3) /* не учитываем платежи на подготовленных и закрытых абонентах */
         )pay group by pay.subs_id
     union all
     /* начисления */
        select ch.subs_id,
               ch.charge_date event_date,
               to_date('01.01.1988','dd.mm.yyyy') paid_session_date,
               to_date('01.01.1988','dd.mm.yyyy') payment_date,
               ch.charge_date charge_date
          from charge 	ch
          join itog_balance ib on ch.ob_id=ib.ob_id
     left join service 	serv on ch.serv_id=serv.serv_id
         where ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ib.ob_edate    >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90
           and ib.ob_edate    <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
           and ch.del_date is null
           and ch.chtype_id = 2 /* Only subs charges  */
           and ch.summ_$ > 0)
      group by subs_id)
      where (paid_session_date <> to_date('01.01.1988','dd.mm.yyyy') or
             payment_date      <> to_date('01.01.1988','dd.mm.yyyy') or
             charge_date       <> to_date('01.01.1988','dd.mm.yyyy'))
) t1
left join (select max(T2_Region_Name)T2_Region_Name, Subs_Id, max(Lac_a)Lac_a, max(Call_Date)call_date, sum(summ) summ from(
select z.T2_Region_Name, t.Subs_Id, T2.Lac_a, T3.Call_Date, t.summ
          from (select Subs_Id,
                       sum(Sum_Price_$) summ,
                       max(Ctraffic_Id) Ctraffic_Id,
                       max(case when Sum_Price_Wo_Dis != 0 then Ctraffic_Id end) Lcd_Ctraffic_Id
                  from Contour_Traffic
                 where Call_Date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
                   and Call_Date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1
                 group by Subs_Id) t
          join Contour_Traffic T2 on t.Ctraffic_Id = T2.Ctraffic_Id
          join Contour_Traffic T3 on t.Lcd_Ctraffic_Id = T3.Ctraffic_Id
          join T2_Zone2region z   on T2.Zone_Id = z.Zone_Id
         union all
        select null, ch.subs_id,null,null, sum(ch.summ_$) summ 
          from charge ch 
         where ch.del_date is null
           and ch.cre_date >= trunc(to_date('15.02.2016','dd.mm.yyyy'))-90 
           and ch.cre_date <  trunc(to_date('15.02.2016','dd.mm.yyyy'))+1  
      group by  ch.subs_id) group by Subs_Id) t2 
      on t1.subs_id=t2.subs_id   
 join Subs_History                    Sh  on t1.Subs_Id = Sh.Subs_Id
 join client_history                  ch  on sh.clnt_id = ch.clnt_id     
 join contract                        con on ch.clnt_id = con.clnt_id   
 left join subs_usi_history           suh on sh.subs_id=suh.subs_id
  and t1.dt+1-1/86400 >= suh.Stime
  and t1.dt+1-1/86400 <  suh.Etime    
 left join usi                        u   on suh.usi_id=u.usi_id
  join (select greatest(nvl(s.activation_date,to_date('31.12.1899','dd.mm.yyyy')),sh.stime) activation_date, s.subs_id
         from subscriber s
         join (select min(stime) stime, subs_id from subs_history group by subs_id) sh on s.subs_id=sh.subs_id ) s on t1.subs_id=s.subs_id
 join (select Cb.Clnt_Id, sum(Cb.Balance_$) Balance_$
         from Client_Balance Cb
         join Smaster.Balance_Dict Bd
           on Cb.Balance_Id = Bd.Balance_Id
          and Bd.Bal_Type_Id not in (2, 5)
     group by Cb.Clnt_Id)             t3  on ch.clnt_id=t3.clnt_id
 left join subs_opt_data              sod on t1.SUBS_ID=sod.subs_id 
  and sod.subs_fld_id=32
  and t1.dt+1-1/86400 >= sod.stime 
  and t1.dt+1-1/86400 <= sod.etime
 join client                          cl  on sh.clnt_id=cl.clnt_id
 left join phone                      p   on sh.phone_id=p.phone_id
  left join (select nvl(min(Event_Date),to_date('01.01.1888','dd.mm.yyyy')) Event_Date, Subs_Id
               from (select min(Pd.Pdoc_Date) Event_Date, p.Subs_Id
                       from Payment p
                       join Pay_Doc Pd
                         on p.Pdoc_Id = Pd.Pdoc_Id
                      group by p.Subs_Id
                     union all
                     select min(Call_Date) Event_Date, Subs_Id
                       from Contour_Traffic
                      where Sum_Price_$ > 0
                      group by Subs_Id
                     union all
                     select min(Ch.Charge_Date) Event_Date, Ch.Subs_Id
                       from Charge Ch
                      where Ch.Chtype_Id=2
                        and Ch.Del_Date is null
                        and Ch.Summ_$ > 0
                      group by Ch.Subs_Id)
              group by Subs_Id) bwc on t1.subs_id=bwc.subs_id where t1.dt+1-1/86400 >= Sh.Stime
   and t1.dt+1-1/86400 <  Sh.Etime
   and t1.dt+1-1/86400 >= ch.Stime
   and t1.dt+1-1/86400 <  ch.Etime 
   and t1.dt+1-1/86400 >= con.Stime
   and t1.dt+1-1/86400 <  con.Etime
   and sh.stat_id not in (3) /* закрытых абонентов не учитываем */
   and ch.ct_id not in (4,5,0) /* не учитываем служебные номера */
   and bwc.Event_Date < t1.dt+1 /* BEGIN_WORK_COM не может быть больше даты выборки */ 

